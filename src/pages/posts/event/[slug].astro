---
import { getCollection } from 'astro:content';
import MainLayout from '../../../layouts/MainLayout.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  
  // Helper to get folder name from ID
  const getFolder = (id: string) => {
    const parts = id.replace(/\\/g, '/').split('/');
    return parts.length > 1 && parts[0] !== 'img' ? parts[0] : 'other';
  };

  // Group posts by Event (Folder)
  const groupedEvents = posts.reduce((acc, post) => {
    const folder = getFolder(post.id);
    if (folder === 'other') return acc;

    if (!acc[folder]) {
      acc[folder] = {
        id: folder,
        title: post.data.event || folder.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
        posts: []
      };
    }
    acc[folder].posts.push(post);
    return acc;
  }, {} as Record<string, { id: string, title: string, posts: typeof posts }>);

  return Object.values(groupedEvents).map(event => ({
    params: { slug: event.id },
    props: { event }
  }));
}

const { event } = Astro.props;

// Get unique categories for filter
const categories = ['All', ...new Set(event.posts.map(post => post.data.category))].sort();

// Helper to format date
const formatDate = (date: Date) => {
  return date.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric'
  });
};
---

<MainLayout
  title={`${event.title} - Writeups`}
  description={`Writeups for ${event.title}`}
>
  <div class="container">
    <div class="header-nav">
      <a href="/posts" class="back-link">&larr; Back to Events</a>
      <h1 class="event-title">{event.title}</h1>
    </div>
    
    <div class="filter-bar">
      <span class="filter-label">Filter by type:</span>
      <div class="filter-buttons">
        {categories.map(cat => (
          <button 
            class={`filter-btn ${cat === 'All' ? 'active' : ''}`}
            data-category={cat}
          >
            {cat}
          </button>
        ))}
      </div>
    </div>
    
    <div class="posts-grid">
      {event.posts
        .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
        .map(post => (
          <a href={`/posts/${post.slug}`} class="post-card" data-category={post.data.category}>
            <div class="card-content">
              <div class="card-eyebrow">
                {post.data.category} 
                {post.data.type && <span class="eyebrow-separator">/</span>} 
                {post.data.type?.toUpperCase()}
              </div>
              <h2 class="card-title">{post.data.title}</h2>
              <p class="card-description">
                {post.data.description || 'No description provided.'}
              </p>
              <div class="card-meta">
                <span class="meta-date">{formatDate(post.data.pubDate)}</span>
              </div>
            </div>
            <div class="card-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg>
            </div>
          </a>
        ))
      }
    </div>
  </div>
</MainLayout>

<script>
  // Function to initialize filtering logic
  function initFilter() {
    const buttons = document.querySelectorAll('.filter-btn');
    const cards = document.querySelectorAll('.post-card');

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        // Update active button
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const category = btn.getAttribute('data-category');

        // Filter cards
        cards.forEach(card => {
          const cardCat = card.getAttribute('data-category');
          if (category === 'All' || cardCat === category) {
            // Restore flex display (important because .post-card is flex)
            (card as HTMLElement).style.display = 'flex'; 
          } else {
            (card as HTMLElement).style.display = 'none';
          }
        });
      });
    });
  }

  // Run on initial load
  initFilter();

  // Run on view transitions navigation
  document.addEventListener('astro:page-load', initFilter);
</script>

<style>
  .container { max-width: 900px; margin: 0 auto; padding: 2rem 1rem; }
  
  .header-nav { margin-bottom: 2rem; }
  
  .back-link {
    display: inline-block;
    color: #8b949e;
    text-decoration: none;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    transition: color 0.2s;
  }
  .back-link:hover { color: #58a6ff; }
  
  .event-title {
    font-size: 2.5rem;
    color: #fff;
    margin: 0;
    font-weight: 700;
  }
  
  /* Filter Bar */
  .filter-bar {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2.5rem;
    flex-wrap: wrap;
    background: #0d1117;
    padding: 0.75rem;
    border: 1px solid #30363d;
    border-radius: 6px;
  }
  
  .filter-label {
    color: #8b949e;
    font-weight: 600;
    font-size: 0.9rem;
  }
  
  .filter-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  
  .filter-btn {
    background: transparent;
    border: 1px solid transparent;
    color: #8b949e;
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
    font-weight: 500;
  }
  
  .filter-btn:hover {
    color: #c9d1d9;
    background: rgba(110, 118, 129, 0.1);
  }
  
  .filter-btn.active {
    background: #238636;
    color: #ffffff;
  }
  
  /* Posts List (Replacing Grid) */
  .posts-grid { display: flex; flex-direction: column; gap: 1rem; }
  
  .post-card {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    background-color: #0d1117;
    border: 1px solid #30363d;
    border-radius: 8px;
    padding: 1.5rem;
    text-decoration: none;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
  }
  
  .post-card:hover {
    border-color: #8b949e;
    transform: translateY(-2px);
    background-color: #161b22;
  }
  
  .card-content {
    flex: 1;
    min-width: 0;
  }

  .card-eyebrow {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: #58a6ff;
    font-weight: 700;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }
  
  .eyebrow-separator {
    color: #30363d;
  }
  
  .card-title {
    font-size: 1.25rem;
    color: #fff;
    margin-bottom: 0.5rem;
    font-weight: 600;
    line-height: 1.4;
  }
  
  .card-description {
    color: #8b949e;
    font-size: 0.95rem;
    margin-bottom: 1rem;
    line-height: 1.6;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    max-width: 90%;
  }

  .card-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    color: #484f58;
  }

  .card-icon {
    margin-left: 1rem;
    color: #484f58;
    transition: color 0.2s;
  }

  .post-card:hover .card-icon {
    color: #fff;
  }

  /* Responsive tweaks */
  @media (max-width: 600px) {
    .filter-bar {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.5rem;
    }
  }
</style>
