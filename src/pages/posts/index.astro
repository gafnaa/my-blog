---
import { getCollection } from 'astro:content';
import MainLayout from '../../layouts/MainLayout.astro';

const posts = await getCollection('blog');

// Helper to get folder name from ID
const getFolder = (id: string) => {
  const parts = id.replace(/\\/g, '/').split('/');
  return parts.length > 1 && parts[0] !== 'img' ? parts[0] : 'other';
};

// Group posts by Event (Folder)
const groupedEvents = posts.reduce((acc, post) => {
  const folder = getFolder(post.id);
  // Removed skipping 'other' to allow root files
  
  if (!acc[folder]) {
    acc[folder] = {
      id: folder,
      title: folder === 'other' ? 'General' : (post.data.event || folder.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())),
      posts: [],
      categories: new Set<string>(),
      dates: []
    };
  }
  
  acc[folder].posts.push(post);
  acc[folder].categories.add(post.data.category);
  acc[folder].dates.push(post.data.pubDate);
  return acc;
}, {} as Record<string, { id: string, title: string, posts: typeof posts, categories: Set<string>, dates: Date[] }>);

// Process event data for display
const events = Object.values(groupedEvents).map(event => {
  const sortedDates = event.dates.sort((a, b) => a.valueOf() - b.valueOf());
  const startDate = sortedDates[0];
  const endDate = sortedDates[sortedDates.length - 1];
  const year = startDate.getFullYear();
  
  // Create a simpler date display for the event card
  const dateDisplay = startDate.getFullYear() === endDate.getFullYear() 
    ? `${year}` 
    : `${startDate.getFullYear()} - ${endDate.getFullYear()}`;

  return {
    ...event,
    dateDisplay,
    categoryList: Array.from(event.categories).sort()
  };
}).sort((a, b) => b.dates[b.dates.length - 1].valueOf() - a.dates[a.dates.length - 1].valueOf()); // Sort by newest

const notes = events.filter(e => e.id === 'ctf-notes');
const writeups = events.filter(e => e.id !== 'ctf-notes');
---

<MainLayout
  title="Blog"
  description="Writesups, events, and other notes"
>
  <div class="container">
    <h1 class="page-title">Blog</h1>
    
    {notes.length > 0 && (
      <div class="section-group">
        <h2 class="section-title">NOTE</h2>
        <div class="posts-grid">
          {notes.map(event => (
            <a href={`/posts/event/${event.id}`} class="post-card">
              <div class="card-content">
                <div class="card-eyebrow">NOTE / CHEATSHEET</div>
                <h2 class="card-title">{event.title}</h2>
                <p class="card-description">
                  Collection of {event.posts.length} challenges covering {event.categoryList.slice(0, 3).join(', ')}
                  {event.categoryList.length > 3 && ' and more'}.
                </p>
                <div class="card-meta">
                  <span class="meta-date">{event.dateDisplay}</span>
                  <span class="meta-count">• {event.posts.length} Posts</span>
                </div>
              </div>
              <div class="card-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg>
              </div>
            </a>
          ))}
        </div>
      </div>
    )}

    {writeups.length > 0 && (
      <div class="section-group">
        <h2 class="section-title">WRITEUP</h2>
        <div class="posts-grid">
          {writeups.map(event => (
            <a href={`/posts/event/${event.id}`} class="post-card">
              <div class="card-content">
                <div class="card-eyebrow">EVENT / CTF</div>
                <h2 class="card-title">{event.title}</h2>
                <p class="card-description">
                  Collection of {event.posts.length} challenges covering {event.categoryList.slice(0, 3).join(', ')}
                  {event.categoryList.length > 3 && ' and more'}.
                </p>
                <div class="card-meta">
                  <span class="meta-date">{event.dateDisplay}</span>
                  <span class="meta-count">• {event.posts.length} Posts</span>
                </div>
              </div>
              <div class="card-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg>
              </div>
            </a>
          ))}
        </div>
      </div>
    )}
  </div>
</MainLayout>

<style>
  .container { max-width: 800px; margin: 0 auto; padding: 4rem 1rem; }
  .page-title { 
    font-size: 3rem; 
    font-weight: 700;
    margin-bottom: 3rem; 
    color: #fff; 
    letter-spacing: -0.02em;
  }
  
  .posts-grid { display: flex; flex-direction: column; gap: 0.4rem; }
  
  .post-card {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    background-color: #0d1117;
    border: 1px solid #30363d;
    border-radius: 8px;
    padding: 1rem 1.25rem;
    text-decoration: none;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
  }
  
  .post-card:hover {
    border-color: #8b949e;
    transform: translateY(-2px);
    background-color: #161b22;
  }
  
  .card-content {
    flex: 1;
    min-width: 0;
  }

  .card-eyebrow {
    font-size: 0.7rem;
    text-transform: uppercase;
    color: #58a6ff;
    font-weight: 700;
    letter-spacing: 0.05em;
    margin-bottom: 0.25rem;
  }
  
  .card-title {
    font-size: 1.1rem;
    color: #fff;
    margin-bottom: 0.25rem;
    font-weight: 600;
    line-height: 1.3;
  }
  
  .card-description {
    color: #8b949e;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
    line-height: 1.5;
  }

  .card-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8rem;
    color: #484f58;
  }
  
  .meta-count {
    color: #8b949e;
  }

  .card-icon {
    margin-left: 1rem;
    color: #484f58;
    transition: color 0.2s;
    margin-top: 0.25rem;
  }

  .section-group {
    margin-bottom: 1.5rem;
  }
  
  .section-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    color: #e6edf3;
    border-bottom: 1px solid #30363d;
    padding-bottom: 0.5rem;
    display: inline-block;
  }
</style>